<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>SecuriCam V23</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link id="manifest-placeholder" rel="manifest">

    <style>
        /* Base */
        body { background-color: #000; color: #fff; overflow: hidden; height: 100vh; width: 100vw; font-family: system-ui, sans-serif; user-select: none; }
        
        #video-wrapper { position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #000; }
        
        video { 
            width: 100%; height: 100%; 
            object-fit: contain; 
            transform: translateZ(0);
        }
        video.filled { object-fit: cover; }

        /* Botões */
        .float-btn {
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px); border-radius: 50%; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; color: white;
        }
        .float-btn:active { background: rgba(255,255,255,0.3); transform: scale(0.95); }

        .talk-btn {
            position: absolute; bottom: 30px; right: 30px; z-index: 60;
            width: 72px; height: 72px; font-size: 24px;
            background: rgba(37, 99, 235, 0.2); border: 2px solid rgba(59, 130, 246, 0.5);
            backdrop-filter: blur(5px); border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.3);
        }
        .talk-btn:active, .talk-btn.talking { 
            background: #2563eb; border-color: #93c5fd; transform: scale(0.95); 
            box-shadow: 0 0 25px #3b82f6; 
        }

        /* Badges */
        .badge {
            position: absolute; z-index: 50;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px);
            padding: 6px 12px; border-radius: 20px; border: 1px solid rgba(59, 130, 246, 0.2);
            font-size: 12px; font-weight: bold; color: #60a5fa;
            display: flex; align-items: center; gap: 6px;
        }
        .top-left { top: 20px; left: 20px; }
        .top-right { top: 20px; right: 20px; }

        /* Stealth Layer */
        #stealth-layer {
            position: fixed; inset: 0; background-color: #000000; z-index: 9999;
            display: none; cursor: none;
        }
        
        /* Lista */
        .cam-item {
            background: linear-gradient(90deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #1e3a8a; border-radius: 10px; padding: 12px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px; cursor: pointer; transition: all 0.2s;
        }
        .cam-item:active { transform: scale(0.98); border-color: #3b82f6; }
    </style>
</head>
<body class="antialiased">

    <!-- MENU SETUP -->
    <div id="ui-setup" class="absolute inset-0 z-50 bg-[#020617] flex flex-col p-6 overflow-y-auto">
        <div class="w-full max-w-sm mx-auto mt-8">
            <div class="text-center mb-8">
                <i class="fa-solid fa-tower-broadcast text-4xl text-blue-500 mb-2"></i>
                <h1 class="text-3xl font-black text-white tracking-tight">SECURICAM <span class="text-blue-500">V23</span></h1>
                <p class="text-[10px] text-blue-300/50 uppercase tracking-widest mt-1 font-bold">V16 Core Restore</p>
            </div>

            <!-- Abas -->
            <div class="bg-blue-950/30 p-1.5 rounded-xl flex mb-6 border border-blue-900/50">
                <button onclick="ui.setMode('camera')" id="tab-cam" class="flex-1 py-3 text-xs font-bold rounded-lg bg-blue-600 text-white shadow-lg">TRANSMITIR</button>
                <button onclick="ui.setMode('monitor')" id="tab-mon" class="flex-1 py-3 text-xs font-bold rounded-lg text-blue-400 hover:text-white">ASSISTIR</button>
            </div>

            <!-- Formulário -->
            <form onsubmit="app.saveAndStart(event)" class="space-y-4">
                <input type="text" id="inp-name" class="w-full bg-blue-950/20 border border-blue-900/50 rounded-xl p-4 text-white focus:border-blue-500 outline-none" placeholder="Apelido (ex: Garagem)" autocomplete="off">
                <div class="flex gap-3">
                    <input type="text" id="inp-id" class="w-full bg-blue-950/20 border border-blue-900/50 rounded-xl p-4 text-white font-mono uppercase focus:border-blue-500 outline-none" placeholder="ID CÂMERA" required autocomplete="off">
                    <input type="password" id="inp-pin" class="w-28 bg-blue-950/20 border border-blue-900/50 rounded-xl p-4 text-center text-white font-mono focus:border-blue-500 outline-none" placeholder="PIN" required inputmode="numeric">
                </div>
                <button type="submit" id="btn-start" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg mt-2 active:scale-95 transition-all">INICIAR</button>
            </form>

            <div id="saved-list-container" class="mt-8 hidden">
                <h3 class="text-xs text-blue-400/70 uppercase font-bold tracking-wider mb-2">Salvos</h3>
                <div id="saved-list" class="space-y-2"></div>
            </div>

            <div id="log" class="text-center text-xs text-red-400 mt-6 min-h-[20px] font-mono font-bold"></div>
        </div>
    </div>

    <!-- APP SCREEN -->
    <div id="ui-app" class="absolute inset-0 z-40 bg-black hidden">
        <div id="video-wrapper">
            <video id="vid-main" autoplay playsinline webkit-playsinline></video>
            <audio id="audio-intercom" autoplay></audio>

            <!-- Badges -->
            <div id="badge-viewers" class="badge top-right hidden">
                <i class="fa-solid fa-users text-blue-400"></i> <span id="viewer-count" class="text-white">0</span>
            </div>
            <div id="badge-status" class="badge top-left hidden">
                <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div> <span id="conn-status" class="text-blue-100">ONLINE</span>
            </div>
            
            <!-- CONTROLES -->
            
            <!-- Botão STEALTH (Só Câmera) -->
            <button id="btn-stealth" onclick="ui.toggleStealth()" class="float-btn w-12 h-12 absolute top-20 right-5 z-50 hidden bg-black/60 border-zinc-700 text-zinc-400">
                <i class="fa-solid fa-ghost"></i>
            </button>

            <!-- Botão Zoom (Monitor) -->
            <button id="btn-fit" onclick="ui.toggleFit()" class="float-btn w-10 h-10 absolute top-20 right-5 z-50 hidden">
                <i class="fa-solid fa-expand" id="icon-fit"></i>
            </button>

            <!-- Botão Falar (Monitor) -->
            <button id="btn-talk" class="talk-btn hidden" onmousedown="app.startTalk()" onmouseup="app.stopTalk()" ontouchstart="app.startTalk()" ontouchend="app.stopTalk()">
                <i class="fa-solid fa-microphone"></i>
            </button>

            <!-- Botão Som -->
            <button id="btn-sound" onclick="ui.unlockAudio()" class="absolute z-50 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-blue-600 text-white px-8 py-4 rounded-full font-bold hidden shadow-xl animate-bounce">
                <i class="fa-solid fa-volume-high mr-2"></i> TOCAR ÁUDIO
            </button>

            <!-- Botão Sair -->
            <div class="absolute bottom-8 left-8 z-50">
                <button onclick="app.stop()" class="w-14 h-14 rounded-full bg-red-500/10 text-red-500 border border-red-500/30 flex items-center justify-center float-btn">
                    <i class="fa-solid fa-power-off text-xl"></i>
                </button>
            </div>
            
            <!-- Botão Trocar Câmera -->
            <div class="absolute bottom-8 left-24 z-50">
                 <button id="btn-swap" onclick="app.swapCam()" class="hidden w-14 h-14 rounded-full bg-blue-900/30 text-blue-200 border border-blue-500/30 flex items-center justify-center float-btn">
                    <i class="fa-solid fa-camera-rotate text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Loader -->
        <div id="loader" class="absolute inset-0 flex flex-col items-center justify-center bg-[#020617] z-20">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-500 mb-6"></i>
            <span id="loader-txt" class="text-xs font-mono text-blue-300/50 tracking-[0.2em] font-bold">CARREGANDO...</span>
        </div>
    </div>

    <!-- STEALTH LAYER -->
    <div id="stealth-layer" ondblclick="ui.toggleStealth()"></div>

    <!-- Keep Awake -->
    <audio id="keep-alive" loop style="display:none;">
        <source src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjIwLjEwMAAAAAAAAAAAAAAA//oeAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAAEAAABIADAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMD//////////////////////////////////////////////////////////////////wAAAAA=" type="audio/mpeg">
    </audio>

    <script>
        // === V16 CORE CONFIG (O QUE FUNCIONA) ===
        const ICE_SERVERS = { 
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ] 
        };
        const PREFIX = "sc-v23-core-";

        // PWA
        const m = { "name": "SecuriCam V23", "display": "standalone", "background_color": "#000000", "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/3682/3682323.png", "sizes": "512x512", "type": "image/png" }] };
        document.getElementById('manifest-placeholder').setAttribute('href', URL.createObjectURL(new Blob([JSON.stringify(m)], {type: 'application/json'})));

        // === UI MODULE ===
        const ui = {
            mode: 'camera',
            
            setMode: (m) => {
                ui.mode = m;
                const bC=document.getElementById('tab-cam'), bM=document.getElementById('tab-mon'), bS=document.getElementById('btn-start');
                const list=document.getElementById('saved-list-container'), inp=document.getElementById('inp-name');
                
                if (m === 'camera') {
                    bC.className="flex-1 py-3 text-xs font-bold rounded-lg bg-blue-600 text-white shadow-lg transition-all";
                    bM.className="flex-1 py-3 text-xs font-bold rounded-lg text-blue-400 hover:text-white transition-all";
                    bS.className=bS.className.replace('bg-green-600','bg-blue-600'); bS.innerHTML=`<i class="fa-solid fa-video mr-2"></i> TRANSMITIR`;
                    list.classList.add('hidden'); inp.classList.add('hidden');
                } else {
                    bM.className="flex-1 py-3 text-xs font-bold rounded-lg bg-blue-600 text-white shadow-lg transition-all";
                    bC.className="flex-1 py-3 text-xs font-bold rounded-lg text-blue-400 hover:text-white transition-all";
                    bS.className=bS.className.replace('bg-blue-600','bg-blue-600'); bS.innerHTML=`<i class="fa-solid fa-eye mr-2"></i> ASSISTIR`;
                    list.classList.remove('hidden'); inp.classList.remove('hidden');
                    storage.renderList();
                }
            },

            log: (msg) => { const e=document.getElementById('log'); e.innerText=msg; if(msg) setTimeout(()=>e.innerText="", 4000); },

            toggleFit: () => {
                const v = document.getElementById('vid-main'), i = document.getElementById('icon-fit');
                if(v.classList.contains('filled')) { v.classList.remove('filled'); i.classList.replace('fa-compress','fa-expand'); }
                else { v.classList.add('filled'); i.classList.replace('fa-expand','fa-compress'); }
            },

            toggleStealth: () => {
                const el = document.getElementById('stealth-layer');
                if(el.style.display === 'none') {
                    el.style.display = 'block';
                    if(!sessionStorage.getItem('stealth_msg')) { alert("Tela Preta. Dois toques para sair."); sessionStorage.setItem('stealth_msg','1'); }
                } else {
                    el.style.display = 'none';
                }
            },

            unlockAudio: () => {
                const v = document.getElementById('vid-main');
                v.muted = false; v.play();
                document.getElementById('btn-sound').classList.add('hidden');
            }
        };

        // === STORAGE ===
        const storage = {
            get: () => JSON.parse(localStorage.getItem('sc_cams_v23') || '[]'),
            add: (name, id, pin) => {
                const list = storage.get().filter(c => c.id !== id);
                list.push({name: name || `Câmera ${id.slice(-3)}`, id, pin});
                localStorage.setItem('sc_cams_v23', JSON.stringify(list));
            },
            remove: (id) => {
                localStorage.setItem('sc_cams_v23', JSON.stringify(storage.get().filter(c => c.id !== id)));
                storage.renderList();
            },
            renderList: () => {
                const container = document.getElementById('saved-list');
                container.innerHTML = "";
                storage.get().forEach(cam => {
                    const div = document.createElement('div');
                    div.className = "cam-item";
                    div.innerHTML = `
                        <div class="flex-1" onclick="app.load('${cam.id}', '${cam.pin}')">
                            <div class="text-sm font-bold text-blue-100">${cam.name}</div>
                            <div class="text-[10px] text-blue-400 font-mono">ID: ${cam.id}</div>
                        </div>
                        <button onclick="storage.remove('${cam.id}')" class="text-blue-800 hover:text-red-500 px-3"><i class="fa-solid fa-trash"></i></button>
                    `;
                    container.appendChild(div);
                });
            }
        };

        // === APP CORE (V16 RESTORED) ===
        const app = {
            peer: null, localStream: null, micStream: null, activeCall: null,
            monitors: [], videoDevices: [], camIndex: 0, watchdog: null,

            saveAndStart: (e) => {
                e.preventDefault();
                const name = document.getElementById('inp-name').value.trim();
                const id = document.getElementById('inp-id').value.trim().replace(/\s/g,'').toLowerCase();
                const pin = document.getElementById('inp-pin').value.trim();
                if(!id||!pin) return ui.log("Preencha ID e PIN");
                if (ui.mode === 'monitor') storage.add(name, id, pin);
                app.start(id, pin);
            },
            load: (id, pin) => {
                document.getElementById('inp-id').value = id;
                document.getElementById('inp-pin').value = pin;
                app.start(id, pin);
            },
            start: async (id, pin) => {
                try { document.getElementById('keep-alive').play(); } catch(e){}
                try { await navigator.wakeLock.request('screen'); } catch(e){}
                document.getElementById('ui-setup').classList.add('hidden');
                document.getElementById('ui-app').classList.remove('hidden');
                if(ui.mode === 'camera') app.startCamera(PREFIX + id, pin);
                else app.startMonitor(PREFIX + id, pin);
            },
            stop: () => {
                if(app.watchdog) clearInterval(app.watchdog);
                if(app.localStream) { app.localStream.getTracks().forEach(t=>t.stop()); app.localStream=null; }
                if(app.micStream) { app.micStream.getTracks().forEach(t=>t.stop()); app.micStream=null; }
                if(app.peer) { app.peer.destroy(); app.peer=null; }
                app.monitors = []; app.activeCall = null;
                document.getElementById('vid-main').srcObject = null;
                document.getElementById('ui-app').classList.add('hidden');
                document.getElementById('ui-setup').classList.remove('hidden');
                document.getElementById('loader').classList.remove('hidden');
                document.getElementById('stealth-layer').style.display = 'none';
                ['btn-talk','btn-swap','btn-sound','btn-fit','badge-viewers','badge-status','btn-stealth'].forEach(i=>document.getElementById(i).classList.add('hidden'));
                if(ui.mode === 'monitor') storage.renderList();
            },

            // CAMERA (NATIVE INIT - SEM RESTRIÇÃO INICIAL)
            startCamera: async (myId, pin) => {
                document.getElementById('btn-swap').classList.remove('hidden');
                document.getElementById('badge-viewers').classList.remove('hidden');
                document.getElementById('btn-stealth').classList.remove('hidden');
                document.getElementById('loader-txt').innerText = "ABRINDO CÂMERA...";

                try {
                    const devs = await navigator.mediaDevices.enumerateDevices();
                    app.videoDevices = devs.filter(d => d.kind === 'videoinput');
                    
                    // FALLBACK: Tenta native resolution primeiro para garantir que abre
                    let stream;
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ audio: {echoCancellation:true}, video: { facingMode: 'environment' } });
                    } catch(err) {
                        stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: true });
                    }
                    app.localStream = stream;
                    const v = document.getElementById('vid-main');
                    v.srcObject = app.localStream; v.muted = true;

                } catch(e) { alert("Erro Câmera: "+e.message); app.stop(); return; }

                document.getElementById('loader-txt').innerText = "CRIANDO SERVIDOR...";
                app.peer = new Peer(myId, { debug: 1, config: ICE_SERVERS });
                
                app.peer.on('open', () => {
                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('badge-status').classList.remove('hidden');
                });
                
                app.peer.on('error', e => {
                    if(e.type==='unavailable-id') { alert("Nome em uso!"); app.stop(); }
                    else ui.log("Erro Rede: " + e.type);
                });

                app.peer.on('connection', conn => {
                    conn.on('data', data => {
                        if (data.auth === pin) {
                            app.monitors.push(conn);
                            document.getElementById('viewer-count').innerText = app.monitors.length;
                            const call = app.peer.call(conn.peer, app.localStream);
                            const sender = call.peerConnection.getSenders().find(s=>s.track.kind==='video');
                            // Limita banda DEPOIS de conectar, para estabilidade
                            if(sender) {
                                const p = sender.getParameters();
                                if(!p.encodings) p.encodings=[{}];
                                p.encodings[0].maxBitrate = 1000000; // 1 Mbps (V16 standard)
                                sender.setParameters(p).catch(()=>{});
                            }
                            conn.on('close', () => { app.monitors = app.monitors.filter(c=>c.peer!==conn.peer); document.getElementById('viewer-count').innerText = app.monitors.length; });
                        }
                    });
                });
                
                app.peer.on('call', call => { call.answer(); call.on('stream', st => { const a=document.getElementById('audio-intercom'); a.srcObject=st; a.play().catch(()=>{}); }); });
            },

            // MONITOR (SIMPLE V16 CONNECT)
            startMonitor: (targetId, pin) => {
                document.getElementById('btn-talk').classList.remove('hidden');
                document.getElementById('btn-fit').classList.remove('hidden');
                document.getElementById('badge-status').classList.remove('hidden');
                document.getElementById('loader-txt').innerText = "CONECTANDO...";
                
                app.peer = new Peer(null, { debug: 1, config: ICE_SERVERS });
                app.peer.on('open', () => app.connect(targetId, pin));
                app.peer.on('error', e => { ui.log("Erro: " + e.type); setTimeout(()=>app.startMonitor(targetId, pin), 3000); });
            },

            connect: (targetId, pin) => {
                const conn = app.peer.connect(targetId);
                conn.on('open', () => { conn.send({auth: pin}); });
                // Sem timeout agressivo, deixa o PeerJS tentar
                
                app.peer.on('call', call => {
                    app.activeCall = call; call.answer();
                    call.on('stream', stream => {
                        document.getElementById('loader').classList.add('hidden');
                        const v = document.getElementById('vid-main');
                        v.srcObject = stream; v.muted = false;
                        v.play().catch(() => { v.muted = true; v.play(); document.getElementById('btn-sound').classList.remove('hidden'); });
                        app.watchdogStart(v);
                    });
                });
            },

            // UTILS (V16 WATCHDOG)
            watchdogStart: (vid) => {
                if(app.watchdog) clearInterval(app.watchdog);
                let lastTime=0;
                app.watchdog = setInterval(() => {
                    if(vid.paused || ui.mode!=='monitor') return;
                    // Simples verificação de congelamento
                    if(vid.currentTime===lastTime && vid.buffered.length>0) {
                        vid.currentTime=vid.buffered.end(0);
                    }
                    lastTime=vid.currentTime;
                    // Delay Killer suave
                    if(vid.buffered.length>0) {
                        const diff=vid.buffered.end(0)-vid.currentTime;
                        if(diff>1.0) vid.currentTime=vid.buffered.end(0);
                        else if(diff>0.3) vid.playbackRate=1.1;
                        else vid.playbackRate=1.0;
                    }
                }, 1000);
            },
            
            startTalk: async () => {
                if (!app.activeCall || ui.mode !== 'monitor') return;
                document.getElementById('btn-talk').classList.add('talking');
                try { app.micStream = await navigator.mediaDevices.getUserMedia({audio:true}); app.peer.call(app.activeCall.peer, app.micStream); } catch(e){ alert("Mic bloqueado"); }
            },
            stopTalk: () => {
                document.getElementById('btn-talk').classList.remove('talking');
                if(app.micStream) { app.micStream.getTracks().forEach(t=>t.stop()); app.micStream=null; }
            },
            swapCam: async () => {
                if(!app.localStream || app.videoDevices.length<2) return;
                app.camIndex=(app.camIndex+1)%app.videoDevices.length;
                app.localStream.getTracks().forEach(t=>t.stop());
                try {
                    app.localStream = await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:true}, video:{deviceId:{exact:app.videoDevices[app.camIndex].deviceId}}});
                } catch(e) { app.localStream = await navigator.mediaDevices.getUserMedia({audio:true, video:true}); }
                document.getElementById('vid-main').srcObject=app.localStream;
                Object.values(app.peer.connections).forEach(conns=>conns.forEach(c=>{
                    const s=c.peerConnection.getSenders().find(s=>s.track.kind==='video');
                    if(s) s.replaceTrack(app.localStream.getVideoTracks()[0]);
                }));
            }
        };
    </script>
</body>
</html>
