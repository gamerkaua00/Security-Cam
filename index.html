<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <title>SecuriCam Gold</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link id="manifest-placeholder" rel="manifest">

    <style>
        body { background-color: #000; color: white; overflow: hidden; height: 100vh; width: 100vw; font-family: system-ui, -apple-system, sans-serif; }
        
        #video-container { 
            position: relative; width: 100%; height: 100%; 
            background: #000; display: flex; align-items: center; justify-content: center;
        }
        
        video { 
            width: 100%; height: 100%; object-fit: contain; 
            transform: translateZ(0); will-change: transform;
        }

        /* Indicador Pulsante */
        .live-dot { width: 8px; height: 8px; background: #ef4444; border-radius: 50%; box-shadow: 0 0 10px #ef4444; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.8); } }

        /* Botão Unmute */
        .unmute-btn {
            position: absolute; z-index: 60; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7); border: 2px solid #fff; color: #fff;
            padding: 15px 30px; border-radius: 50px; font-weight: bold; cursor: pointer;
            backdrop-filter: blur(5px); display: flex; align-items: center; gap: 10px;
        }
        
        /* Stats discreto */
        .status-pill {
            position: absolute; top: 15px; left: 15px; z-index: 50;
            background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(10px);
            padding: 5px 12px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 600; color: #e5e5e5;
        }
    </style>
</head>
<body class="select-none">

    <!-- SETUP SCREEN -->
    <div id="ui-setup" class="absolute inset-0 z-50 bg-neutral-950 flex flex-col items-center justify-center p-6 transition-opacity duration-300">
        <div class="w-full max-w-sm">
            <div class="text-center mb-10">
                <i class="fa-solid fa-shield-cat text-4xl text-blue-500 mb-3"></i>
                <h1 class="text-2xl font-bold tracking-tight text-white">SECURICAM <span class="text-blue-500">GOLD</span></h1>
                <p class="text-[10px] text-zinc-500 uppercase tracking-widest mt-1">Realtime Audio & Video</p>
            </div>

            <div class="bg-neutral-900 p-1.5 rounded-xl flex mb-6 border border-neutral-800">
                <button onclick="setMode('camera')" id="tab-cam" class="flex-1 py-3 text-xs font-bold rounded-lg bg-blue-600 text-white shadow-lg transition-all">TRANSMITIR</button>
                <button onclick="setMode('monitor')" id="tab-mon" class="flex-1 py-3 text-xs font-bold rounded-lg text-zinc-500 hover:text-white transition-all">ASSISTIR</button>
            </div>

            <form onsubmit="init(event)" class="space-y-4">
                <input type="text" id="inp-id" class="w-full bg-black border border-neutral-800 rounded-xl p-4 text-center text-white font-mono uppercase focus:border-blue-600 outline-none transition-colors placeholder-zinc-800" placeholder="NOME DA CÂMERA" required autocomplete="off">
                <input type="password" id="inp-pin" class="w-full bg-black border border-neutral-800 rounded-xl p-4 text-center text-white font-mono focus:border-blue-600 outline-none transition-colors placeholder-zinc-800" placeholder="SENHA" required inputmode="numeric">
                
                <button type="submit" id="btn-start" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2 mt-2">
                    INICIAR
                </button>
            </form>
            <div id="log-msg" class="text-center text-xs text-red-400 mt-6 min-h-[20px]"></div>
        </div>
    </div>

    <!-- APP SCREEN -->
    <div id="ui-app" class="absolute inset-0 z-40 bg-black hidden flex flex-col">
        <div id="video-container">
            <video id="vid" autoplay playsinline webkit-playsinline></video>
            
            <!-- Botão Gigante de Ativar Som (Só aparece no Monitor) -->
            <button id="btn-unmute" onclick="enableAudio()" class="unmute-btn hidden">
                <i class="fa-solid fa-volume-high"></i> TOCAR ÁUDIO
            </button>

            <!-- Status -->
            <div class="status-pill">
                <div class="live-dot"></div>
                <span id="status-txt">AO VIVO</span>
            </div>

            <!-- Loader -->
            <div id="loader" class="absolute inset-0 flex flex-col items-center justify-center bg-black/90 z-20">
                <i class="fa-solid fa-circle-notch fa-spin text-3xl text-blue-600 mb-4"></i>
                <span id="loader-txt" class="text-xs font-mono text-zinc-400">CONECTANDO...</span>
            </div>
        </div>

        <!-- Barra de Controle -->
        <div class="absolute bottom-6 left-0 right-0 flex justify-center gap-6 z-50 pointer-events-auto">
            <button onclick="stopApp()" class="w-14 h-14 rounded-full bg-red-600/20 text-red-500 border border-red-600/50 flex items-center justify-center active:bg-red-600 active:text-white backdrop-blur-md transition-colors">
                <i class="fa-solid fa-power-off text-xl"></i>
            </button>
            
            <button id="btn-swap" onclick="swapCam()" class="hidden w-14 h-14 rounded-full bg-zinc-800/50 text-white border border-white/10 flex items-center justify-center active:bg-zinc-700 backdrop-blur-md transition-colors">
                <i class="fa-solid fa-rotate text-xl"></i>
            </button>
        </div>
    </div>

    <script>
        // === CORE CONFIG ===
        const PREFIX = "sc-gold-";
        let mode = 'camera';
        let peer = null;
        let localStream = null;
        let videoDevices = [];
        let camIndex = 0;
        let syncLoop = null;
        let conn = null;

        // PWA Manifest
        const m = { "name": "SecuriCam Gold", "display": "standalone", "background_color": "#000000", "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/3682/3682323.png", "sizes": "512x512", "type": "image/png" }] };
        document.getElementById('manifest-placeholder').setAttribute('href', URL.createObjectURL(new Blob([JSON.stringify(m)], {type: 'application/json'})));

        // === UI ===
        function setMode(m) {
            mode = m;
            const bC = document.getElementById('tab-cam');
            const bM = document.getElementById('tab-mon');
            const bS = document.getElementById('btn-start');
            if (m === 'camera') {
                bC.classList.add('bg-blue-600', 'text-white', 'shadow-lg'); bC.classList.remove('text-zinc-500');
                bM.classList.remove('bg-green-600', 'text-white', 'shadow-lg'); bM.classList.add('text-zinc-500');
                bS.innerText = "TRANSMITIR AGORA"; bS.className = bS.className.replace('bg-green-600', 'bg-blue-600');
            } else {
                bM.classList.add('bg-green-600', 'text-white', 'shadow-lg'); bM.classList.remove('text-zinc-500');
                bC.classList.remove('bg-blue-600', 'text-white', 'shadow-lg'); bC.classList.add('text-zinc-500');
                bS.innerText = "CONECTAR MONITOR"; bS.className = bS.className.replace('bg-blue-600', 'bg-green-600');
            }
        }

        async function init(e) {
            e.preventDefault();
            const id = document.getElementById('inp-id').value.trim().replace(/\s/g, '').toLowerCase();
            const pin = document.getElementById('inp-pin').value.trim();
            if(!id || !pin) return log("Preencha todos os campos");

            document.getElementById('ui-setup').classList.add('hidden');
            document.getElementById('ui-app').classList.remove('hidden');

            if (mode === 'camera') await startSender(PREFIX + id, pin);
            else startReceiver(PREFIX + id, pin);
        }

        function stopApp() {
            if(syncLoop) cancelAnimationFrame(syncLoop);
            if(localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; }
            if(conn) conn.close();
            if(peer) { peer.destroy(); peer = null; }
            
            document.getElementById('vid').srcObject = null;
            document.getElementById('ui-app').classList.add('hidden');
            document.getElementById('ui-setup').classList.remove('hidden');
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('btn-swap').classList.add('hidden');
            document.getElementById('btn-unmute').classList.add('hidden');
            log("");
        }

        function log(msg) {
            const el = document.getElementById('log-msg');
            el.innerText = msg;
            if(msg) setTimeout(() => el.innerText = "", 4000);
        }

        // === SENDER (CÂMERA) ===
        async function startSender(myId, pin) {
            document.getElementById('btn-swap').classList.remove('hidden');
            document.getElementById('loader-txt').innerText = "INICIANDO CÂMERA...";

            try {
                try {
                    const d = await navigator.mediaDevices.enumerateDevices();
                    videoDevices = d.filter(x => x.kind === 'videoinput');
                } catch(e){}

                // Constraints focadas em VELOCIDADE DE ÁUDIO
                const constraints = {
                    audio: {
                        latency: 0, // Latência zero no hardware
                        echoCancellation: false, // Desliga processamento pesado
                        noiseSuppression: false, // Desliga supressão (mais ruído, mas muito mais rápido)
                        autoGainControl: false
                    },
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 }, height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    }
                };

                try {
                    localStream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch(e) {
                    localStream = await navigator.mediaDevices.getUserMedia({audio: true, video: true});
                }

                document.getElementById('vid').srcObject = localStream;
                document.getElementById('vid').muted = true; // Mute local sempre

                document.getElementById('loader-txt').innerText = "CONECTANDO P2P...";
                
                peer = new Peer(myId, { debug: 0 });
                
                peer.on('error', e => {
                    if(e.type === 'unavailable-id') log("ID EM USO");
                    else log("ERRO: " + e.type);
                    setTimeout(stopApp, 2000);
                });

                peer.on('connection', c => {
                    c.on('data', d => {
                        if(d.auth === pin) {
                            conn = c;
                            document.getElementById('loader').classList.add('hidden');
                            const call = peer.call(c.peer, localStream);
                            
                            // Max Bandwidth Unlock
                            const sender = call.peerConnection.getSenders().find(s => s.track.kind === 'video');
                            if(sender) {
                                const p = sender.getParameters();
                                if(!p.encodings) p.encodings = [{}];
                                p.encodings[0].maxBitrate = 5000000; // 5 Mbps
                                p.encodings[0].networkPriority = 'high';
                                sender.setParameters(p);
                            }
                        }
                    });
                    c.on('close', () => { document.getElementById('loader').classList.remove('hidden'); });
                });

            } catch(e) { log(e.message); setTimeout(stopApp, 2000); }
        }

        // === RECEIVER (MONITOR) ===
        function startReceiver(targetId, pin) {
            document.getElementById('loader-txt').innerText = "BUSCANDO CÂMERA...";
            
            peer = new Peer(null, { debug: 0 });

            peer.on('open', () => {
                const c = peer.connect(targetId);
                conn = c;
                
                c.on('open', () => {
                    document.getElementById('loader-txt').innerText = "AUTENTICANDO...";
                    c.send({auth: pin});
                });

                c.on('data', d => { if(d.error) { log(d.error); setTimeout(stopApp, 2000); }});
                
                setTimeout(() => {
                    if(!document.getElementById('loader').classList.contains('hidden')) {
                        log("Sem resposta...");
                        setTimeout(stopApp, 2000);
                    }
                }, 10000);
            });

            peer.on('call', call => {
                call.answer();
                call.on('stream', stream => {
                    document.getElementById('loader').classList.add('hidden');
                    const vid = document.getElementById('vid');
                    vid.srcObject = stream;
                    vid.muted = false; // Garante desmudo
                    
                    // Mostra botão de áudio se o browser bloquear
                    const playPromise = vid.play();
                    if(playPromise !== undefined) {
                        playPromise.catch(() => {
                            vid.muted = true; 
                            vid.play();
                            document.getElementById('btn-unmute').classList.remove('hidden');
                        });
                    }

                    // === HYBRID SYNC ENGINE (VIDEO + AUDIO SAFE) ===
                    const loop = () => {
                        if(!vid.paused && vid.buffered.length > 0) {
                            const end = vid.buffered.end(0);
                            const cur = vid.currentTime;
                            const diff = end - cur;

                            // Estratégia Híbrida:
                            if (diff > 0.5) {
                                // Atraso Grande (> 0.5s): Pulo (Corte seco)
                                // Necessário para não acumular segundos de delay
                                vid.currentTime = end;
                            } else if (diff > 0.1) {
                                // Atraso Pequeno (0.1s - 0.5s): Aceleração
                                // Isso mantém o áudio funcionando sem cortes
                                vid.playbackRate = 1.5;
                            } else {
                                // Sincronizado
                                vid.playbackRate = 1.0;
                            }
                        }
                        syncLoop = requestAnimationFrame(loop);
                    };
                    loop();
                });
                
                call.on('close', () => { log("Desconectado"); setTimeout(stopApp, 2000); });
            });
        }

        function enableAudio() {
            const vid = document.getElementById('vid');
            vid.muted = false;
            vid.play(); // Tenta tocar novamente com som
            document.getElementById('btn-unmute').classList.add('hidden');
        }

        async function swapCam() {
            if(!localStream || videoDevices.length < 2) return;
            camIndex = (camIndex + 1) % videoDevices.length;
            localStream.getTracks().forEach(t => t.stop());
            
            const constraints = {
                audio: { latency: 0, echoCancellation: false, noiseSuppression: false },
                video: { deviceId: { exact: videoDevices[camIndex].deviceId }, width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: 30 }
            };
            
            localStream = await navigator.mediaDevices.getUserMedia(constraints);
            document.getElementById('vid').srcObject = localStream;
            
            Object.values(peer.connections).forEach(conns => {
                conns.forEach(c => {
                    const s = c.peerConnection.getSenders().find(s => s.track.kind === 'video');
                    if(s) s.replaceTrack(localStream.getVideoTracks()[0]);
                });
            });
        }
    </script>
</body>
</html>